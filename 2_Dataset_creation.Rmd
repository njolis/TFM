---
title: 'Data clean-up and data curation'
author: NÃºria Jolis Orriols
date: '`r format(Sys.Date(),"%e de %B, %Y")`' 
output:
  pdf_document:
    keep_tex: yes
    toc: yes
    df_print: kable
    highlight: tango
  html_notebook:
    df_print: paged
    toc: yes
    toc_float: true
    theme: united
    highlight: tango
  html_document:
    df_print: paged
    toc: yes
    toc_float: true
    theme: united
    highlight: tango
---

```{r packages, message=FALSE, warning=FALSE}
libraries <- c("readr", "tidyverse", "naniar" ,"ggplot2", "car", "dplyr", "reshape2", "patchwork", "rstatix", "gridExtra", "mice", "VIM")
check.libraries <- is.element(libraries, installed.packages()[, 1])==FALSE
libraries.to.install <- libraries[check.libraries]
if (length(libraries.to.install!=0)) {
  install.packages(libraries.to.install)
}

success <- sapply(libraries,require, quietly = FALSE,  character.only = TRUE)
if(length(success) != length(libraries)) {stop("A package failed to return a success in require() function.")}
```

# Obtaining the data

```{r}
data<- read.csv("data.Li21.csv", sep=";")
```

```{r, echo=FALSE}
#1
data<-data[complete.cases(data$outcome), ]
data<-data[,3:51]
#2
m.a.p<-(data$systolic.blood.pressure+2*data$diastolic.blood.pressure)/3
data<-cbind(data, m.a.p)
data<-data[,-c(15:16)]
#3
data$outcome<-factor(data$outcome, labels=c("Survivor", "Non-survivor"))
data$gender<-factor(data$gender, labels=c("M", "F"))
data$hypertensive<-factor(data$hypertensive, labels=c("No", "Yes"))
data$atrialfibrillation<-factor(data$atrialfibrillation, labels=c("No", "Yes"))
data$renal.failure<-factor(data$renal.failure, labels=c("No", "Yes"))
data$hyperlipemia<-factor(data$hyperlipemia, labels=c("No", "Yes"))
data$diabetes<-factor(data$diabetes, labels=c("No", "Yes"))
data$depression<-factor(data$depression, labels=c("No", "Yes"))
data$deficiencyanemias<-factor(data$deficiencyanemias, labels=c("No", "Yes"))
data$COPD<-factor(data$COPD, labels=c("No", "Yes"))
data$CHD.with.no.MI<-factor(data$CHD.with.no.MI, labels=c("No", "Yes"))
str(data)
```
Finally, we got a dataset of 1176 observations and 48 variables being 39 numeric and 11 factors. Outcome is the response variable whose behavior shall be modeled and the 49 variables left are considered to be candidate predictors.

In order to perform models for outcome prediction an exploratory data analysis is going to be performed first. 

# Checking for missing values

```{r}
#Determine the total number of missing values
sum(is.na(data))
#In percentage and graphic visualization
round(mean(is.na(data))*100, 1)
vis_miss(data)
#Variables with % of missing values
x1<-apply(is.na(data), 2, mean)
x2<-round(x1[x1>0], 3)*100 #%NA per variable
x2
```

The 3.4% of the values are missing and are concentrated in 21 of the 50 variables. Of those 21 variables, 8 of them present more than 10% of missing values: "basophils", "creatine.kinase", "lactic.acid", "BMI", "neutrophils", "lymphocyte", "pH" and "PCO2".

```{r, message = FALSE, warning=FALSE}
#Missing values visualization wit VIM package
missing_values <- data %>% summarize_each(funs(sum(is.na(.))/n()))

missing_values <- gather(missing_values, key="feature", value="missing_pct")
missing_values %>% 
  ggplot(aes(x=reorder(feature,-missing_pct),y=missing_pct), xlab="% of missing values", ylab="Variables") +
    geom_bar(stat="identity",fill="red")+
      coord_flip()+theme_bw()

```

# Data clean-up and data curation

In order to study the models performance we will create five different datasets: 

## Dataset A

```{r}
dataA<-data
dim(dataA) #Dimensions of the original dataset
round(mean(is.na(dataA))*100, 2)#% of the missing values
table(dataA$outcome)
```

The original dataset contains 1176 observations, 48 variables and 3,4% of missing values. 

## Dataset B = listwise deletion

This method creates a subset with the complete observations.
```{r}
sum(complete.cases(dataA))#Determine the complete observations
nrow(dataA)-sum(complete.cases(dataA))#Determine the observations with missing values
dataB<-na.omit(dataA)#Create the dataset omitting the missing values 
sum(is.na(dataB))#Checking for missing values
dim(dataB)# Dimensions of the new dataset
table(dataB$outcome)
```
The dataset B after appying the listwise deletion consist in 428 complete observations and 48 variables.

## Dataset C = deletion of variables with \>15% NA

This method is another kind of deletion method where the features with \>15% of missing values are deleted.
```{r}
dataC<- dataA[, which((apply(is.na(dataA), 2, mean)*100)<15)]
round(mean(is.na(dataC))*100, 2)#Checking for missing values
dim(dataC)# Dimensions of the new dataset
table(dataC$outcome)
```

This second method creates a data set with 1177 observations, 43 variables and an 1,22% of missing values. The omitted variables are PCO2, PH, Basophils, Lactic.acid and BMI.

## Dataset D = KNN imputations

This third method is a type of imputation method of handling missing values. It consists in a machine learning-based method that uses a Euclidean distance to find the nearest neighbors. 
```{r}
k<- round(sqrt(nrow(dataA))) #Determine the best k
dataD<-kNN(dataA, variable = colnames(dataA), k = 34, imp_var = FALSE) #Generate the imputation with k=34
round(mean(is.na(dataD)*100), 2)#Checking for missing values
dim(dataD)# Dimensions of the new dataset
table(dataD$outcome)
```
This imputation method creates a data set with the same dimensions as dataset A but without missing values (1176 observations and 48 variables). 

## Dataset E = multiple imputation

Another imputation method which consist in generating  multiple imputed values from the observed data.
```{r, warning=FALSE}
columns<- c("PCO2", "pH", "basophils", "lactic.acid", "BMI", "creatine.kinase", "lymphocyte", "neutrophils", "urine.output", "PT", "INR", "temperature", "glucose", 'm.a.p', "heart.rate", "respiratory.rate", "SP.O2", "blood.calcium") #Create a vector with the variables that need to be imputated.
pmm.data<- mice(dataA[,names(dataA) %in% columns], seed=12345, printFlag = FALSE, m = 30)#Generate the imputation
imputed.data<- mice::complete(pmm.data)
complete.data<-dataA[, which((apply(is.na(dataA), 2, mean)*100)<0.01)]
dataE<-cbind(complete.data, imputed.data)#Create the new dataset
round(mean(is.na(dataE)*100), 2)#Checking for missing values
dim(dataE)# Dimensions of the new dataset
table(dataE$outcome)
```

The multiple imputation method also creates a data set with the same dimensions as dataset A but without missing values (1176 observations and 48 variables). 

