---
title: 'Multivariate analysis: multiple logistic regression'
author: Núria Jolis Orriols
date: '`r format(Sys.Date(),"%e de %B, %Y")`' 
output:
  pdf_document:
    toc: yes
    df_print: kable
header-includes:
  - \usepackage[english]{babel}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NULL, cache=TRUE, error = TRUE)
options(width=90)
```

```{r packages, message=FALSE, echo=FALSE, warning=FALSE}
libraries <- c("kernlab", "ggplot2" ,"caret", "tidyverse", "dplyr", "gmodels", "MASS")
check.libraries <- is.element(libraries, installed.packages()[, 1])==FALSE
libraries.to.install <- libraries[check.libraries]
if (length(libraries.to.install!=0)) {
  install.packages(libraries.to.install)
}

success <- sapply(libraries,require, quietly = FALSE,  character.only = TRUE)
if(length(success) != length(libraries)) {stop("A package failed to return a success in require() function.")}
```

# Step 1 - Obtaining datasets

```{r}
dataA <- read.csv("data/datasetA.csv",stringsAsFactors=T)
dataB <- read.csv("data/datasetB.csv",stringsAsFactors=T)
dataC <- read.csv("data/datasetC.csv",stringsAsFactors=T)
dataD <- read.csv("data/datasetD.csv",stringsAsFactors=T)
```

# Step 2 - Generate multiple logistic regresion models 

<<<<<<< HEAD
For each dataset the full model is first generated. After, the stepAIC() function of the MASS package is used to select the most contributing variables according to the lowest AIC.
=======
For each dataset the full model is first generated. After, the stepAIC() function of the MASS package is used to select the most contributive variables according to the lowest AIC.
>>>>>>> 5462a01b46a715d22da86b12d2f6be2dbdf9b457

## Data A

### Full logistic regression model

```{r}
xnames <- names(dataA[2:48])
foriA<- as.formula(paste("outcome ~ ", paste(xnames, collapse= "+")))
```


```{r}
full_mlrA<- glm(foriA, data = dataA, family = 'binomial')
summary(full_mlrA)
```
The full model with dataset A found the variables age, presence of deficiencyanemia, presence of renal.failure, temperature, platelets and PCO2 to be statistically significant.

### Perform stepwise variable selection

```{r, message=FALSE, warning=FALSE}
step_mlrA<- full_mlrA %>% stepAIC(trace = FALSE)
```

<<<<<<< HEAD
It is not possible to reduce the model with the stepAIC() function on the dataset A because there are missing values.
=======
It is not possible to reduce the model with the stepAIC() function on the dataset A because there are missing values. The model fitting must apply the models to the same dataset and dimensions and with the missing values the dimensions of the dataset changes. 
>>>>>>> 5462a01b46a715d22da86b12d2f6be2dbdf9b457

## Data B

### Full logistic regression model

```{r}
xnamesB <- names(dataB[2:48])
foriB<- as.formula(paste("outcome ~ ", paste(xnamesB, collapse= "+")))
```


```{r}
full_mlrB<- glm(foriB, data = dataB, family = 'binomial')
summary(full_mlrB)
```

The full model found the variables age, deficiencyanemia, renal.failure, temperature, platelets and PCO2 to be statistically significant.

### Perform stepwise variable selection

The stepAIC function of the MASS package will be used to select the most contributive variables:

```{r, message=FALSE, warning=FALSE}
step_mlrB <- full_mlrB %>% stepAIC(trace = FALSE)
summary(step_mlrB)
```

The function chose a final model with the following formula: 

```{r}
formula(step_mlrB)
cbind("Estimate"=coef(summary(step_mlrB))[,1], "Odds"=exp(coef(step_mlrB)), coef(summary(step_mlrB))[,2:4])%>% kable(format="pandoc", round(3))
```

<<<<<<< HEAD
=======
Las varialbes age, heart.rate, leucocyte, PT, urea.nitrogen, glucose, chloride, anion.gap, magnesium.ion, PCO2 tienen coeficiente negativo por la que probabilidad de sobrevivir disminuye respecto un aumento de estas variables teniendo en cuenta las demás varaibles incluidas en el modelo.
las variables BMI, artrialfibrillation (Yes), deficiencyanemias(Yes), renal.failure(Yes), COPDYes, temperature, platelets, neutrophils, lymphocyte, bloof.calcium tienen un coeficiente positivo, por lo que la probabilidad de sobrevivir aumenta respecto a un aumento de estas variables considerando las demás variables incluidas en el modelo.

Este modelo define un modelo multiplicativo para los ODDS. 
Así un cambio de una unidad en X supondría que los ODDS se multiplicarían por exp(coeficiente).

Por ejemplo, un aumento en la unidad de la edad (es decir, con un año más), supondria que tienen 0.95 (exp(-0.05)) veces más de sobrevivir, por tanto como es menor que 1,  quiere decir que a más edad, menos probabilidad de supervivencia.


>>>>>>> 5462a01b46a715d22da86b12d2f6be2dbdf9b457
## Data C

### Full logistic regression model

```{r}
xnamesC <- names(dataC[2:40])
foriC<- as.formula(paste("outcome ~ ", paste(xnamesC, collapse= "+")))
```


```{r}
full_mlrC<- glm(foriC, data = dataC, family = 'binomial')
summary(full_mlrC)
```

### Perform stepwise variable selection

The stepAIC function of the MASS package will be used to select the most contributive variables:

```{r, message=FALSE,warning=FALSE}
step_mlrC <- full_mlrC %>% stepAIC(trace = FALSE)
summary(step_mlrC)
```

```{r}
formula(step_mlrC)
cbind("Estimate"=coef(summary(step_mlrC))[,1], "Odds"=exp(coef(step_mlrC)), coef(summary(step_mlrC))[,2:4])%>% kable(format="pandoc", round(3))
```

## Data D

### Full logistic regression model

```{r, message=FALSE}
xnamesD <- names(dataD[2:48])
foriD<- as.formula(paste("outcome ~ ", paste(xnamesD, collapse= "+")))
```


```{r}
full_mlrD<- glm(foriD, data = dataD, family = 'binomial')
summary(full_mlrD)
```

The full model found the variables age, deficiencyanemia, renal.failure, temperature, platelets and PCO2 to be statistically significant.

### Perform stepwise variable selection

The stepAIC function of the MASS package will be used to select the most contributive variables:

```{r, message=FALSE,warning=FALSE}
step_mlrD <- full_mlrD %>% stepAIC(trace = FALSE)
summary(step_mlrD)
```

The function chose a final model with the following formula: 

```{r}
formula(step_mlrD)
cbind("Estimate"=coef(summary(step_mlrD))[,1], "Odds"=exp(coef(step_mlrD)), coef(summary(step_mlrD))[,2:4])%>% kable(format="pandoc", round(3))
```
<<<<<<< HEAD
=======



The function chose a final model with the following formula: 

outcome ~ age + BMI + atrialfibrillation + deficiencyanemias + 
    renal.failure + COPD + heart.rate + temperature + leucocyte + 
    platelets + neutrophils + lymphocyte + PT + urea.nitrogen + 
    glucose + blood.calcium + chloride + anion.gap + magnesium.ion + 
    PCO2
 
It found the variables age, deficiencyanemia, renal.failure, temperature, SP.O2, platelets, leucocyte, neutrophils, lymphocyte, blood.calcium, blood.potassium, bicarbonate, pH and PCO2 to be statistically significant.

>>>>>>> 5462a01b46a715d22da86b12d2f6be2dbdf9b457
